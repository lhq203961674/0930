hosts 切替作業におけるバックアップと戻しの考え方

/etc/hosts の切替作業では、事前に現行の hosts ファイルを作業用ディレクトリに日付付きでバックアップしておく必要がある。切替後および戻し作業では、常にバックアップを基準として復元可否を確認することが重要であり、バックアップの保持自体が作業の正当性を担保する役割を持つ。

⸻

cp と mv の使い分けが本番作業に与える影響

cp は元ファイルを保持したまま複製を行う操作であり、復元や回滚作業に適している。一方 mv はファイルを移動させる操作で、元のファイルが消失するため、基準となるバックアップを破壊する可能性がある。本番環境の戻し手順において mv を使用することは適切ではない。

⸻

diff 確認における比較対象の意味付け

diff コマンドの結果は、どのファイル同士を比較するかによって意味が大きく変わる。切替後の確認では /etc/hosts と DR 用に持ち込んだ hosts ファイルを比較し、戻し後の確認では /etc/hosts と切替前に取得したバックアップ hosts を比較することで、作業結果を客観的に判断できる。

⸻

戻し作業後に差分がなくなるべき条件

戻し作業が正しく完了している場合、現在の /etc/hosts と切替前に取得した hosts のバックアップファイルとの間には差分が存在しない状態となる。この状態を diff により確認することで、元の環境に完全に復元されたことを証明できる。

⸻

WORK_DIR とカレントディレクトリの役割の違い

WORK_DIR は作業ファイルの配置場所を明示的に管理するための変数であり、コマンド実行時のカレントディレクトリとは別概念である。スクリプト内で WORK_DIR を参照しない限り、定義しただけではファイル探索や送信先に影響を与えない。

⸻

for 文を用いた確認処理の等価性

複数拠点に対する確認処理を for 文でループ化した場合、各ホストに対して個別にコマンドを実行した場合と論理的な結果は同一となる。対象を変数として定義することで、可読性と保守性を高めつつ、確認漏れのリスクを低減できる。

⸻

ping と nc による疎通確認の役割差

ping は ICMP を用いたネットワークレベルの疎通確認であり、通信経路の存在を確認する目的で使用される。一方 nc は TCP ポートへの接続可否を確認するため、SSH や SFTP といった実際の業務通信が成立するかどうかを確認する手段として有効である。

⸻

hosts 切替状態の判定方法

現在の /etc/hosts がどのファイルと一致しているかによって、システムが切替状態にあるのか、あるいは元の状態に戻っているのかを判断できる。状態判定は目視ではなく diff による差分確認を基準とすることで、作業の客観性が確保される。

⸻

ファイル命名規則が運用手順に与える効果

作業用ディレクトリ内のファイルは、その役割が即座に判別できる命名とすることが望ましい。DR 用、切替前バックアップ用などの区別を明確にすることで、誤操作を防止し、第三者による手順確認や監査対応を容易にする。
